name: test api autotests


on:
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Test scope: all, post, post_negative, put, patch'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - post
          - post_negative
          - put
          - patch

jobs:
  run-tests:
    runs-on: ubuntu-latest
    outputs:
      report-path: _site

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
          echo "Added $(pwd) to PYTHONPATH"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run all tests
        if: ${{ github.event.inputs.deployment_target == 'all' }}
        run: pytest --alluredir=allure-results -v

      - name: Run tests with @pytest.mark.post
        if: ${{ github.event.inputs.deployment_target == 'post' }}
        run: pytest -m post --alluredir=allure-results -v

      - name: Run tests with @pytest.mark.post_negative
        if: ${{ github.event.inputs.deployment_target == 'post_negative' }}
        run: pytest -m post_negative --alluredir=allure-results -v

      - name: Run tests with @pytest.mark.put
        if: ${{ github.event.inputs.deployment_target == 'put' }}
        run: pytest -m put --alluredir=allure-results -v

      - name: Run tests with @pytest.mark.patch
        if: ${{ github.event.inputs.deployment_target == 'patch' }}
        run: pytest -m patch --alluredir=allure-results -v

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Install Allure 2.25.0
        run: |
          wget --no-check-certificate https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.25.0/allure-commandline-2.25.0.zip
          unzip allure-commandline-*.zip -d allure
          ALLURE_BIN_DIR=$(find allure -path "*/bin" -type d 2>/dev/null | head -1)
          if [ -z "$ALLURE_BIN_DIR" ]; then
            echo "Error: Allure bin directory not found!" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "$ALLURE_BIN_DIR" >> $GITHUB_PATH
          echo "Allure bin path: $ALLURE_BIN_DIR"

      - name: Generate Allure report
        run: allure generate allure-results --clean -o _site

      - name: Save Allure history
        run: |
          mkdir -p allure-results/history
          cp -r _site/history/* allure-results/history/ || true

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: _site/
          retention-days: 1

  publish-report:
    name: Publish Allure Report to GitHub Pages
    runs-on: ubuntu-latest
    needs: run-tests
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download report artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: _site

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5
